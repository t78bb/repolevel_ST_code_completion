# CodeBLEU è¯„ä¼°é›†æˆæŒ‡å—

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. åˆ›å»ºè¯„ä¼°æ¨¡å—

åœ¨ `evaluate/` ç›®å½•ä¸‹åˆ›å»ºäº†å®Œæ•´çš„ CodeBLEU è¯„ä¼°æ¨¡å—ï¼š

- `codebleu_evaluator.py` - æ ¸å¿ƒè¯„ä¼°å‡½æ•°
- `__init__.py` - æ¨¡å—å¯¼å‡º
- `README.md` - ä½¿ç”¨æ–‡æ¡£
- `test_evaluation.py` - æµ‹è¯•è„šæœ¬

### 2. é›†æˆåˆ°ç”Ÿæˆæµç¨‹

å·²å°† CodeBLEU è¯„ä¼°é›†æˆåˆ° `full_process.py` ä¸­ï¼š

- åœ¨ä¿®å¤æ­¥éª¤å®ŒæˆåŽè‡ªåŠ¨æ‰§è¡Œè¯„ä¼°
- æ·»åŠ  `--skip_evaluate` å‚æ•°æ”¯æŒè·³è¿‡è¯„ä¼°
- æ¯ä¸ªé¡¹ç›®çš„è¯„ä¼°ç»“æžœå•ç‹¬ä¿å­˜ä¸º `codebleu_evaluation.json`

### 3. è¯„ä¼°ç»“æžœè¾“å‡º

å¯¹äºŽæ¯ä¸ªé¡¹ç›®ï¼ˆä¾‹å¦‚ï¼š`output/20260120_205101_fixed/repoeval_three-axis_CNC_motion`ï¼‰ï¼Œä¼šç”Ÿæˆï¼š

```
repoeval_three-axis_CNC_motion/
â”œâ”€â”€ generations_repoeval-function_repoeval-function.json  # ç”Ÿæˆçš„ä»£ç 
â”œâ”€â”€ results.jsonl                                          # å‚è€ƒä»£ç 
â”œâ”€â”€ codebleu_evaluation.json                              # â­ æ–°å¢žï¼šè¯„ä¼°ç»“æžœ
â”œâ”€â”€ outputs.json
â”œâ”€â”€ readful_result/
â””â”€â”€ logs/
```

## ðŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³• 1ï¼šå®Œæ•´æµç¨‹ï¼ˆæŽ¨èï¼‰

è¿è¡Œå®Œæ•´æµç¨‹ï¼ŒåŒ…å«ç”Ÿæˆã€ä¿®å¤å’Œè¯„ä¼°ï¼š

```bash
python full_process.py --project three-axis_CNC_motion
```

### æ–¹æ³• 2ï¼šè·³è¿‡è¯„ä¼°

å¦‚æžœä¸éœ€è¦è¯„ä¼°ï¼š

```bash
python full_process.py --project three-axis_CNC_motion --skip_evaluate
```

### æ–¹æ³• 3ï¼šåªæ‰§è¡Œè¯„ä¼°

å¯¹å·²ç»ä¿®å¤å®Œæˆçš„é¡¹ç›®å•ç‹¬è¯„ä¼°ï¼š

```bash
python evaluate/codebleu_evaluator.py "output/20260120_205101_fixed/repoeval_three-axis_CNC_motion"
```

### æ–¹æ³• 4ï¼šæ‰¹é‡è¯„ä¼°

å¯¹å¤šä¸ªå·²ä¿®å¤é¡¹ç›®è¿›è¡Œè¯„ä¼°ï¼š

```bash
# å¯¹ 20260120_205101_fixed ä¸‹çš„æ‰€æœ‰é¡¹ç›®è¯„ä¼°
for dir in output/20260120_205101_fixed/repoeval_*/; do
    python evaluate/codebleu_evaluator.py "$dir"
done
```

## ðŸ“Š è¯„ä¼°ç»“æžœç¤ºä¾‹

`codebleu_evaluation.json` å†…å®¹ï¼š

```json
{
  "project_name": "repoeval_three-axis_CNC_motion",
  "num_cases": 3,
  "language": "python",
  "weights": [0.25, 0.25, 0.25, 0.25],
  "average_scores": {
    "codebleu": 0.6345,
    "ngram_match_score": 0.5234,
    "weighted_ngram_match_score": 0.5678,
    "syntax_match_score": 0.7123,
    "dataflow_match_score": 0.6890
  },
  "case_results": [
    {
      "case_id": 0,
      "codebleu": 0.6234,
      "ngram_match_score": 0.5123,
      ...
    }
  ]
}
```

## ðŸ”„ å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”Ÿæˆä»£ç     â”‚
â”‚ (Generator) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¿®å¤ä»£ç     â”‚
â”‚ (Verifier)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â­ æ–°å¢žæ­¥éª¤
â”‚ CodeBLEU    â”‚
â”‚  è¯„ä¼°       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¿å­˜è¯„ä¼°ç»“æžœ â”‚
â”‚ .json æ–‡ä»¶  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸ“ è¯„ä¼°æµç¨‹è¯´æ˜Ž

1. **è¯»å–æ•°æ®**
   - è¯»å– `generations_xxx.json` èŽ·å–ç”Ÿæˆçš„ä»£ç 
   - è¯»å– `results.jsonl` èŽ·å–å‚è€ƒä»£ç ï¼ˆground_truthï¼‰

2. **è®¡ç®— CodeBLEU**
   - å¯¹æ¯ä¸ªæ ·æœ¬è®¡ç®— CodeBLEU åˆ†æ•°
   - åŒ…å« 4 ä¸ªå­æŒ‡æ ‡ï¼šn-gramã€åŠ æƒ n-gramã€è¯­æ³•æ ‘ã€æ•°æ®æµ

3. **ä¿å­˜ç»“æžœ**
   - è®¡ç®—å¹³å‡åˆ†æ•°
   - ä¿å­˜è¯¦ç»†çš„æ¯ä¸ª case çš„è¯„ä¼°ç»“æžœ
   - è¾“å‡ºåˆ°é¡¹ç›®ç›®å½•ä¸‹çš„ `codebleu_evaluation.json`

## âš™ï¸ é…ç½®è¯´æ˜Ž

### è¯­è¨€è®¾ç½®

å½“å‰é»˜è®¤ä½¿ç”¨ `python` ä½œä¸ºè¯­è¨€ï¼ˆå› ä¸º CodeBLEU åŽŸç”Ÿä¸æ”¯æŒ STï¼‰ï¼š

```python
evaluate_and_save(
    project_dir,
    lang="python"  # ST ä»£ç ä½¿ç”¨ python è§£æžå™¨ä½œä¸ºè¿‘ä¼¼
)
```

### æƒé‡è®¾ç½®

CodeBLEU å„ç»„ä»¶çš„é»˜è®¤æƒé‡ä¸º `(0.25, 0.25, 0.25, 0.25)`ï¼š

```python
weights = (
    0.25,  # ngram_match
    0.25,  # weighted_ngram_match  
    0.25,  # syntax_match
    0.25   # dataflow_match
)
```

## ðŸ§ª æµ‹è¯•

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½ï¼š

```bash
python evaluate/test_evaluation.py
```

## ðŸ“¦ ä¾èµ–è¦æ±‚

ç¡®ä¿å·²å®‰è£…å¿…è¦çš„ä¾èµ–ï¼š

```bash
pip install "tree-sitter>=0.22.0,<0.24.0" "tree-sitter-python~=0.21"
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ST è¯­è¨€æ”¯æŒ**ï¼šCodeBLEU ä¸ç›´æŽ¥æ”¯æŒ STï¼Œä½¿ç”¨ Python è§£æžå™¨ä½œä¸ºè¿‘ä¼¼
2. **è¯„ä¼°æ—¶é—´**ï¼šå¤§é¡¹ç›®å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ
3. **æ–‡ä»¶è¦æ±‚**ï¼šå¿…é¡»æœ‰ `generations_xxx.json` å’Œ `results.jsonl`

## ðŸŽ¯ åˆ†æ•°è§£è¯»

| åˆ†æ•°èŒƒå›´ | è¯„ä»· | è¯´æ˜Ž |
|---------|------|------|
| 0.8-1.0 | ä¼˜ç§€ | ç”Ÿæˆä»£ç ä¸Žå‚è€ƒä»£ç éžå¸¸ç›¸ä¼¼ |
| 0.6-0.8 | è‰¯å¥½ | ç”Ÿæˆä»£ç è´¨é‡è¾ƒå¥½ï¼Œæœ‰ä¸€å®šå·®å¼‚ |
| 0.4-0.6 | ä¸­ç­‰ | ç”Ÿæˆä»£ç åŸºæœ¬å¯ç”¨ï¼Œéœ€è¦æ”¹è¿› |
| < 0.4   | è¾ƒå·® | ç”Ÿæˆä»£ç ä¸Žå‚è€ƒä»£ç å·®å¼‚è¾ƒå¤§ |

## ðŸ“ž é—®é¢˜åé¦ˆ

å¦‚æžœé‡åˆ°é—®é¢˜ï¼š

1. æ£€æŸ¥ä¾èµ–æ˜¯å¦æ­£ç¡®å®‰è£…
2. ç¡®è®¤é¡¹ç›®ç›®å½•åŒ…å«å¿…è¦æ–‡ä»¶
3. æŸ¥çœ‹è¯„ä¼°æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯



